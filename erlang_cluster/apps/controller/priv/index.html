<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
  </head>
  <body>
    <style>
      body {
        font-family: Tahoma, Geneva, sans-serif;
      }

      div {
        display: inline;
      }
    </style>

    <script>
      function updateStats(memuse) {
        console.log(memuse.progress);
        document.getElementById('progress').innerHTML = parseFloat(memuse.progress);
      }
      setInterval(function(){ var date = new Date(); ws.send(JSON.stringify({'keepalive':date.getTime()})); }, 30000);

      function connect() {
        var host = window.document.location.host.replace(/:.*/, '');
        var ws = new WebSocket('ws://' + host + ':1337/websocket');  // standalone config
        //var ws = new WebSocket('wss://' + host + '/websocket');  // heroku config
        ws.onopen = function () {
          console.log("connected to websocket");
          document.getElementById('wsclosed').style.display = "none"
          //to avoid error H15 and socket termination: https://devcenter.heroku.com/articles/http-routing#timeouts
          setInterval(function(){ var date = new Date(); ws.send(JSON.stringify({'keepalive':date.getTime()})); }, 30000);
        };
        ws.onmessage = function (event) {
          updateStats(JSON.parse(event.data));
        };
        ws.onclose = function (event) {
          console.log("websocket connection closed");
          document.getElementById('wsclosed').style.display = "block"
          switch (event.code){
          case 1000:  // CLOSE_NORMAL
            break;
          default:
            setTimeout(function() {
              connect();
            }, 1000);
            break;
          }
        };
      }

      connect();
    </script>

    <div id='wsclosed' style='display: none;'><center><i>connection closed</i></center></div>
    <h2>Erlang websocket example with cowboy</h2>
    <strong>Server Stats</strong><br>
    Progress: <div id='progress'></div><br>
  </body>
</html>
